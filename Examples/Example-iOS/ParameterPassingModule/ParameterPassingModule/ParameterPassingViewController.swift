//
//  ParameterPassingViewController.swift
//  ParameterPassingModule
//
//  Created by RouterKit Example on 2025/1/23.
//

import UIKit
import RouterKit

/// ÂèÇÊï∞‰º†ÈÄíÁ§∫‰æã‰∏ªÈ°µÈù¢
class ParameterPassingViewController: UIViewController, Routable {
    
    // MARK: - Routable Protocol Implementation
    static func viewController(with parameters: RouterParameters?) -> UIViewController? {
        let vc = ParameterPassingViewController()
        vc.routeContext = RouteContext(url: "/parameter-passing", parameters: parameters ?? [:], moduleName: "ParameterPassingModule")
        return vc
    }
    
    static func performAction(_ action: String, parameters: RouterParameters?, completion: @escaping RouterCompletion) {
        completion(.failure(RouterError.actionNotFound(action)))
    }
    
    var routeContext: RouteContext?
    private var buttonActions: [() -> Void] = []
    
    private let scrollView = UIScrollView()
    private let contentView = UIView()
    private let stackView = UIStackView()
    
    override func viewDidLoad() {
        super.viewDidLoad()
        setupUI()
        setupExampleSections()
        processReceivedParameters()
    }
    
    private func setupUI() {
        title = "ÂèÇÊï∞‰º†ÈÄíÁ§∫‰æã"
        view.backgroundColor = .systemBackground
        
        // ËÆæÁΩÆÊªöÂä®ËßÜÂõæ
        scrollView.translatesAutoresizingMaskIntoConstraints = false
        contentView.translatesAutoresizingMaskIntoConstraints = false
        stackView.translatesAutoresizingMaskIntoConstraints = false
        
        view.addSubview(scrollView)
        scrollView.addSubview(contentView)
        contentView.addSubview(stackView)
        
        stackView.axis = .vertical
        stackView.spacing = 20
        stackView.alignment = .fill
        stackView.distribution = .fill
        
        NSLayoutConstraint.activate([
            scrollView.topAnchor.constraint(equalTo: view.safeAreaLayoutGuide.topAnchor),
            scrollView.leadingAnchor.constraint(equalTo: view.leadingAnchor),
            scrollView.trailingAnchor.constraint(equalTo: view.trailingAnchor),
            scrollView.bottomAnchor.constraint(equalTo: view.bottomAnchor),
            
            contentView.topAnchor.constraint(equalTo: scrollView.topAnchor),
            contentView.leadingAnchor.constraint(equalTo: scrollView.leadingAnchor),
            contentView.trailingAnchor.constraint(equalTo: scrollView.trailingAnchor),
            contentView.bottomAnchor.constraint(equalTo: scrollView.bottomAnchor),
            contentView.widthAnchor.constraint(equalTo: scrollView.widthAnchor),
            
            stackView.topAnchor.constraint(equalTo: contentView.topAnchor, constant: 20),
            stackView.leadingAnchor.constraint(equalTo: contentView.leadingAnchor, constant: 20),
            stackView.trailingAnchor.constraint(equalTo: contentView.trailingAnchor, constant: -20),
            stackView.bottomAnchor.constraint(equalTo: contentView.bottomAnchor, constant: -20)
        ])
    }
    
    private func setupExampleSections() {
        // È°µÈù¢Ê†áÈ¢òÂíåÊèèËø∞
        let titleLabel = createTitleLabel("RouterKit ÂèÇÊï∞‰º†ÈÄíÁ§∫‰æã")
        stackView.addArrangedSubview(titleLabel)
        
        let descriptionLabel = createDescriptionLabel(
            "Êú¨È°µÈù¢Â±ïÁ§∫‰∫ÜRouterKit‰∏≠ÂêÑÁßçÂèÇÊï∞‰º†ÈÄíÊñπÂºèÁöÑ‰ΩøÁî®Á§∫‰æãÔºåÂåÖÊã¨Âü∫Á°ÄÂèÇÊï∞„ÄÅÂ§çÊùÇÂØπË±°„ÄÅÂõûË∞ÉÂáΩÊï∞„ÄÅÂÖ®Â±ÄÁä∂ÊÄÅÂíåÊï∞ÊçÆÊµÅÁ≠â„ÄÇ"
        )
        stackView.addArrangedSubview(descriptionLabel)
        
        stackView.addArrangedSubview(createSeparator())
        
        // Âü∫Á°ÄÂèÇÊï∞‰º†ÈÄí
        let basicSection = createExampleSection(
            title: "Âü∫Á°ÄÂèÇÊï∞‰º†ÈÄí",
            description: "Â±ïÁ§∫Â≠óÁ¨¶‰∏≤„ÄÅÊï∞Â≠ó„ÄÅÂ∏ÉÂ∞îÂÄº„ÄÅÊï∞ÁªÑ„ÄÅÂ≠óÂÖ∏Á≠âÂü∫Á°ÄÊï∞ÊçÆÁ±ªÂûãÁöÑ‰º†ÈÄí",
            icon: "üìù",
            route: "/ParameterPassingModule/basicParameter",
            examples: [
                "Â≠óÁ¨¶‰∏≤ÂèÇÊï∞‰º†ÈÄí",
                "Êï∞Â≠óÂíåÂ∏ÉÂ∞îÂÄº‰º†ÈÄí",
                "Êï∞ÁªÑÂíåÂ≠óÂÖ∏‰º†ÈÄí",
                "URLÊü•ËØ¢ÂèÇÊï∞",
                "Ë∑ØÂæÑÂèÇÊï∞Ëß£Êûê"
            ]
        )
        stackView.addArrangedSubview(basicSection)
        
        // Â§çÊùÇÂØπË±°‰º†ÈÄí
        let complexSection = createExampleSection(
            title: "Â§çÊùÇÂØπË±°‰º†ÈÄí",
            description: "Â±ïÁ§∫Ëá™ÂÆö‰πâÂØπË±°„ÄÅÊ®°ÂûãÊï∞ÊçÆ„ÄÅÂµåÂ•óÁªìÊûÑÁ≠âÂ§çÊùÇÊï∞ÊçÆÁöÑ‰º†ÈÄí",
            icon: "üèóÔ∏è",
            route: "/ParameterPassingModule/complexObject",
            examples: [
                "Áî®Êà∑‰ø°ÊÅØÂØπË±°",
                "‰∫ßÂìÅËØ¶ÊÉÖÊï∞ÊçÆ",
                "ËÆ¢Âçï‰ø°ÊÅØ‰º†ÈÄí",
                "JSONÂ∫èÂàóÂåñ‰º†ÈÄí",
                "Base64ÁºñÁ†Å‰º†ÈÄí"
            ]
        )
        stackView.addArrangedSubview(complexSection)
        
        // ÂõûË∞ÉÂáΩÊï∞‰º†ÈÄí
        let callbackSection = createExampleSection(
            title: "ÂõûË∞ÉÂáΩÊï∞‰º†ÈÄí",
            description: "Â±ïÁ§∫ÊàêÂäü„ÄÅÂ§±Ë¥•„ÄÅÂÆåÊàê„ÄÅËøõÂ∫¶Á≠âÂêÑÁßçÂõûË∞ÉÂáΩÊï∞ÁöÑ‰º†ÈÄíÂíåÊâßË°å",
            icon: "üîÑ",
            route: "/ParameterPassingModule/callback",
            examples: [
                "ÊàêÂäüÂíåÂ§±Ë¥•ÂõûË∞É",
                "ÂÆåÊàêÂõûË∞ÉÂ§ÑÁêÜ",
                "ËøõÂ∫¶Êõ¥Êñ∞ÂõûË∞É",
                "Êï∞ÊçÆÈÄâÊã©ÂõûË∞É",
                "ÂØºËà™ÂõûË∞ÉÈìæ"
            ]
        )
        stackView.addArrangedSubview(callbackSection)
        
        // ÂÖ®Â±ÄÁä∂ÊÄÅ‰º†ÈÄí
        let globalStateSection = createExampleSection(
            title: "ÂÖ®Â±ÄÁä∂ÊÄÅ‰º†ÈÄí",
            description: "Â±ïÁ§∫ÈÄöËøáÂÖ®Â±ÄÁä∂ÊÄÅÁÆ°ÁêÜÂô®ËøõË°åË∑®È°µÈù¢Êï∞ÊçÆÂÖ±‰∫´ÂíåÁä∂ÊÄÅÂêåÊ≠•",
            icon: "üåê",
            route: "/ParameterPassingModule/globalState",
            examples: [
                "Áî®Êà∑Áä∂ÊÄÅÁÆ°ÁêÜ",
                "Â∫îÁî®ÈÖçÁΩÆÁä∂ÊÄÅ",
                "Êï∞ÊçÆÁºìÂ≠òÁä∂ÊÄÅ",
                "Áä∂ÊÄÅËßÇÂØüËÄÖÊ®°Âºè",
                "Áä∂ÊÄÅÊåÅ‰πÖÂåñ"
            ]
        )
        stackView.addArrangedSubview(globalStateSection)
        
        // Êï∞ÊçÆÊµÅ‰º†ÈÄí
        let dataFlowSection = createExampleSection(
            title: "Êï∞ÊçÆÊµÅ‰º†ÈÄí",
            description: "Â±ïÁ§∫ÂÆûÊó∂Êï∞ÊçÆÊµÅ„ÄÅ‰∫ã‰ª∂ÊµÅ„ÄÅÂìçÂ∫îÂºèÊï∞ÊçÆ‰º†ÈÄíÁ≠âÈ´òÁ∫ßÂäüËÉΩ",
            icon: "üåä",
            route: "/ParameterPassingModule/dataFlow",
            examples: [
                "ÂÆûÊó∂Êï∞ÊçÆÊµÅ",
                "‰∫ã‰ª∂ÊµÅÂ§ÑÁêÜ",
                "Êï∞ÊçÆÊµÅËøáÊª§",
                "Êï∞ÊçÆÊµÅÂêàÂπ∂",
                "Ë∑®È°µÈù¢Êï∞ÊçÆÊµÅ"
            ]
        )
        stackView.addArrangedSubview(dataFlowSection)
        
        stackView.addArrangedSubview(createSeparator())
        
        // ÁªºÂêàÊµãËØïÂå∫Âüü
        let testSection = createTestSection()
        stackView.addArrangedSubview(testSection)
    }
    
    private func processReceivedParameters() {
        guard let context = routeContext else { return }
        
        print("\n=== ParameterPassingViewController Êé•Êî∂Âà∞ÁöÑÂèÇÊï∞ ===")
        for (key, value) in context.parameters {
            print("\(key): \(value)")
        }
        print("=== ÂèÇÊï∞ÊòæÁ§∫ÁªìÊùü ===\n")
        
        // Â¶ÇÊûúÊúâÁâπÂÆöÁöÑÁ§∫‰æãÁ±ªÂûãÂèÇÊï∞ÔºåÁõ¥Êé•ÂØºËà™Âà∞ÂØπÂ∫îÈ°µÈù¢
        if let exampleType = context.parameters["exampleType"] as? String {
            navigateToExample(exampleType)
        }
    }
    
    // MARK: - UI Helper Methods
    
    private func createTitleLabel(_ text: String) -> UILabel {
        let label = UILabel()
        label.text = text
        label.font = .boldSystemFont(ofSize: 24)
        label.textAlignment = .center
        label.textColor = .label
        label.numberOfLines = 0
        return label
    }
    
    private func createDescriptionLabel(_ text: String) -> UILabel {
        let label = UILabel()
        label.text = text
        label.font = .systemFont(ofSize: 16)
        label.textAlignment = .center
        label.textColor = .secondaryLabel
        label.numberOfLines = 0
        return label
    }
    
    private func createExampleSection(title: String, description: String, icon: String, route: String, examples: [String]) -> UIView {
        let containerView = UIView()
        containerView.backgroundColor = .secondarySystemBackground
        containerView.layer.cornerRadius = 12
        containerView.layer.shadowColor = UIColor.black.cgColor
        containerView.layer.shadowOffset = CGSize(width: 0, height: 2)
        containerView.layer.shadowRadius = 4
        containerView.layer.shadowOpacity = 0.1
        
        let stackView = UIStackView()
        stackView.axis = .vertical
        stackView.spacing = 12
        stackView.translatesAutoresizingMaskIntoConstraints = false
        
        // Ê†áÈ¢òË°å
        let titleStackView = UIStackView()
        titleStackView.axis = .horizontal
        titleStackView.spacing = 8
        titleStackView.alignment = .center
        
        let iconLabel = UILabel()
        iconLabel.text = icon
        iconLabel.font = .systemFont(ofSize: 24)
        
        let titleLabel = UILabel()
        titleLabel.text = title
        titleLabel.font = .boldSystemFont(ofSize: 18)
        titleLabel.textColor = .label
        
        titleStackView.addArrangedSubview(iconLabel)
        titleStackView.addArrangedSubview(titleLabel)
        titleStackView.addArrangedSubview(UIView()) // Spacer
        
        // ÊèèËø∞
        let descLabel = UILabel()
        descLabel.text = description
        descLabel.font = .systemFont(ofSize: 14)
        descLabel.textColor = .secondaryLabel
        descLabel.numberOfLines = 0
        
        // Á§∫‰æãÂàóË°®
        let examplesLabel = UILabel()
        let exampleText = examples.map { "‚Ä¢ \($0)" }.joined(separator: "\n")
        examplesLabel.text = "ÂåÖÂê´Á§∫‰æã:\n\(exampleText)"
        examplesLabel.font = .systemFont(ofSize: 12)
        examplesLabel.textColor = .tertiaryLabel
        examplesLabel.numberOfLines = 0
        
        // ÂØºËà™ÊåâÈíÆ
        let button = UIButton(type: .system)
        button.setTitle("Êü•ÁúãÁ§∫‰æã ‚Üí", for: .normal)
        button.titleLabel?.font = .boldSystemFont(ofSize: 16)
        button.backgroundColor = .systemBlue
        button.setTitleColor(.white, for: .normal)
        button.layer.cornerRadius = 8
        button.contentEdgeInsets = UIEdgeInsets(top: 12, left: 20, bottom: 12, right: 20)
        
        button.addTarget(self, action: #selector(buttonTapped(_:)), for: .touchUpInside)
        button.tag = buttonActions.count
        buttonActions.append {
            Router.push(to: route)
        }
        
        stackView.addArrangedSubview(titleStackView)
        stackView.addArrangedSubview(descLabel)
        stackView.addArrangedSubview(examplesLabel)
        stackView.addArrangedSubview(button)
        
        containerView.addSubview(stackView)
        
        NSLayoutConstraint.activate([
            stackView.topAnchor.constraint(equalTo: containerView.topAnchor, constant: 16),
            stackView.leadingAnchor.constraint(equalTo: containerView.leadingAnchor, constant: 16),
            stackView.trailingAnchor.constraint(equalTo: containerView.trailingAnchor, constant: -16),
            stackView.bottomAnchor.constraint(equalTo: containerView.bottomAnchor, constant: -16)
        ])
        
        return containerView
    }
    
    private func createTestSection() -> UIView {
        let containerView = UIView()
        containerView.backgroundColor = .tertiarySystemBackground
        containerView.layer.cornerRadius = 12
        
        let stackView = UIStackView()
        stackView.axis = .vertical
        stackView.spacing = 16
        stackView.translatesAutoresizingMaskIntoConstraints = false
        
        // Ê†áÈ¢ò
        let titleLabel = UILabel()
        titleLabel.text = "üß™ ÁªºÂêàÊµãËØï"
        titleLabel.font = .boldSystemFont(ofSize: 18)
        titleLabel.textAlignment = .center
        
        // ÊµãËØïÊåâÈíÆ
        let testButtons = [
            ("ÊµãËØïÊâÄÊúâÂü∫Á°ÄÂèÇÊï∞", { self.testAllBasicParameters() }),
            ("ÊµãËØïÂ§çÊùÇÂØπË±°‰º†ÈÄí", { self.testComplexObjectPassing() }),
            ("ÊµãËØïÂõûË∞ÉÂáΩÊï∞Èìæ", { self.testCallbackChain() }),
            ("ÊµãËØïÂÖ®Â±ÄÁä∂ÊÄÅÂêåÊ≠•", { self.testGlobalStateSync() }),
            ("ÊµãËØïÊï∞ÊçÆÊµÅ‰º†ÈÄí", { self.testDataFlowPassing() })
        ]
        
        stackView.addArrangedSubview(titleLabel)
        
        for (title, action) in testButtons {
            let button = createTestButton(title: title, action: action)
            stackView.addArrangedSubview(button)
        }
        
        containerView.addSubview(stackView)
        
        NSLayoutConstraint.activate([
            stackView.topAnchor.constraint(equalTo: containerView.topAnchor, constant: 16),
            stackView.leadingAnchor.constraint(equalTo: containerView.leadingAnchor, constant: 16),
            stackView.trailingAnchor.constraint(equalTo: containerView.trailingAnchor, constant: -16),
            stackView.bottomAnchor.constraint(equalTo: containerView.bottomAnchor, constant: -16)
        ])
        
        return containerView
    }
    
    private func createTestButton(title: String, action: @escaping () -> Void) -> UIButton {
        let button = UIButton(type: .system)
        button.setTitle(title, for: .normal)
        button.titleLabel?.font = .systemFont(ofSize: 16)
        button.backgroundColor = .systemGreen
        button.setTitleColor(.white, for: .normal)
        button.layer.cornerRadius = 8
        button.contentEdgeInsets = UIEdgeInsets(top: 10, left: 16, bottom: 10, right: 16)
        
        button.addTarget(self, action: #selector(buttonTapped(_:)), for: .touchUpInside)
        button.tag = buttonActions.count
        buttonActions.append(action)
        
        return button
    }
    
    private func createSeparator() -> UIView {
        let separator = UIView()
        separator.backgroundColor = .separator
        separator.translatesAutoresizingMaskIntoConstraints = false
        separator.heightAnchor.constraint(equalToConstant: 1).isActive = true
        return separator
    }
    
    // MARK: - Navigation Methods
    
    private func navigateToExample(_ exampleType: String) {
        let route: String
        switch exampleType {
        case "basic":
            route = "/ParameterPassingModule/basicParameter"
        case "complex":
            route = "/ParameterPassingModule/complexObject"
        case "callback":
            route = "/ParameterPassingModule/callback"
        case "globalState":
            route = "/ParameterPassingModule/globalState"
        case "dataFlow":
            route = "/ParameterPassingModule/dataFlow"
        default:
            print("Êú™Áü•ÁöÑÁ§∫‰æãÁ±ªÂûã: \(exampleType)")
            return
        }
        
        Router.push(to: route)
    }
    
    // MARK: - Test Methods
    
    private func testAllBasicParameters() {
        let parameters: [String: Any] = [
            "testMode": true,
            "testString": "ÁªºÂêàÊµãËØïÂ≠óÁ¨¶‰∏≤",
            "testNumber": 12345,
            "testArray": ["item1", "item2", "item3"],
            "testDict": ["key1": "value1", "key2": 42],
            "testBool": true,
            "source": "ParameterPassingViewController"
        ]
        
        Router.push(to: "/ParameterPassingModule/basicParameter", parameters: parameters)
    }
    
    private func testComplexObjectPassing() {
        let userInfo = UserInfo(
            id: 999,
            name: "ÊµãËØïÁî®Êà∑",
            email: "test@example.com",
            avatar: "https://example.com/avatar.jpg"
        )
        
        let productInfo = ProductInfo(
            id: "TEST_PRODUCT_001",
            title: "ÊµãËØïÂïÜÂìÅ",
            description: "ËøôÊòØ‰∏Ä‰∏™Áî®‰∫éÊµãËØïÁöÑÂïÜÂìÅ",
            price: 299.99,
            category: "ÊµãËØïÂàÜÁ±ª",
            images: ["image1.jpg", "image2.jpg"]
        )
        
        let parameters: [String: Any] = [
            "testMode": true,
            "userInfo": ParameterPassingUtils.encode(userInfo) ?? [:],
            "productInfo": ParameterPassingUtils.encode(productInfo) ?? [:],
            "source": "ParameterPassingViewController"
        ]
        
        Router.push(to: "/ParameterPassingModule/complexObject", parameters: parameters)
    }
    
    private func testCallbackChain() {
        let successCallback: SuccessCallback = { result in
            print("ÁªºÂêàÊµãËØï - ÊàêÂäüÂõûË∞É: \(result)")
        }
        
        let failureCallback: FailureCallback = { error in
            print("ÁªºÂêàÊµãËØï - Â§±Ë¥•ÂõûË∞É: \(error)")
        }
        
        let completionCallback: CompletionCallback = {
            print("ÁªºÂêàÊµãËØï - ÂÆåÊàêÂõûË∞É")
        }
        
        let parameters: [String: Any] = [
            "testMode": true,
            "callbackChain": true,
            "source": "ParameterPassingViewController"
        ]
        
        // Ê≥®ÂÜåÂõûË∞É
        CallbackManager.shared.registerCallback("test_success", callback: successCallback)
        CallbackManager.shared.registerCallback("test_failure", callback: failureCallback)
        CallbackManager.shared.registerCallback("test_completion", callback: completionCallback)
        
        Router.push(to: "/ParameterPassingModule/callback", parameters: parameters)
    }
    
    private func testGlobalStateSync() {
        // ËÆæÁΩÆÊµãËØïÁî®ÁöÑÂÖ®Â±ÄÁä∂ÊÄÅ
        GlobalStateManager.shared.setUserState([
            "userId": 999,
            "userName": "ÁªºÂêàÊµãËØïÁî®Êà∑",
            "testMode": true,
            "syncTime": Date().timeIntervalSince1970
        ])
        
        GlobalStateManager.shared.setAppState([
            "testSession": UUID().uuidString,
            "testStartTime": Date().timeIntervalSince1970,
            "testType": "comprehensive"
        ])
        
        let parameters: [String: Any] = [
            "testMode": true,
            "syncTest": true,
            "source": "ParameterPassingViewController"
        ]
        
        Router.push(to: "/ParameterPassingModule/globalState", parameters: parameters)
    }
    
    private func testDataFlowPassing() {
        let testStreamId = "comprehensiveTestStream"
        
        // ÂàõÂª∫ÊµãËØïÊï∞ÊçÆÊµÅ
        let testData = [
            "testId": UUID().uuidString,
            "testType": "comprehensive",
            "message": "ÁªºÂêàÊµãËØïÊï∞ÊçÆÊµÅ",
            "timestamp": Date().timeIntervalSince1970,
            "source": "ParameterPassingViewController"
        ] as [String : Any]
        
        DataFlowManager.shared.publish(to: testStreamId, data: testData)
        
        let parameters: [String: Any] = [
            "testMode": true,
            "streamId": testStreamId,
            "streamAction": "subscribe_test_stream",
            "source": "ParameterPassingViewController"
        ]
        
        Router.push(to: "/ParameterPassingModule/dataFlow", parameters: parameters)
    }
    
    @objc private func buttonTapped(_ sender: UIButton) {
        if sender.tag < buttonActions.count {
            buttonActions[sender.tag]()
        }
    }
}
